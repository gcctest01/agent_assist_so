<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistant Agent Assist - Watsonx Orchestrate</title>

<!-- Convertisseur Markdown ‚Üí HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 12px; background: #f9f9f9; }
h2,h3 { color:#004080; }

/* Messages */
#messageContainer {
  background:#fff; border:1px solid #ccc; border-radius:6px;
  padding:12px; max-height:500px; overflow-y:auto;
  margin-bottom:20px;
  white-space:normal; 
}

.chat-message .sender {
  color:#004080; font-weight:bold; margin-bottom:4px;
}
.chat-message .content {
  white-space: normal;
  font-family: Arial; 
  line-height:1.45;
}

/* TABLEAUX MARKDOWN RENDUS BEAUTIFUL */
table {
  border-collapse: collapse;
  width: 100%;
  margin: 10px 0;
  font-size: 14px;
}
table th, table td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
table th {
  background: #e8f0ff;
  font-weight: bold;
}
table tr:nth-child(even) {
  background: #f9f9f9;
}

/* Suggestions */
#suggestionsList {
  border:1px solid #ccc; border-radius:6px; background:white;
  max-height:200px; overflow-y:auto; padding:8px; margin-bottom:10px;
}

.suggestion-item {
  padding:10px; border-bottom:1px solid #eee; cursor:pointer;
  color:#004080; white-space: normal;
}
.suggestion-item:hover { background:#d0e1ff; }

/* Input zone */
#inputContainer {
  margin-top:20px; background:#fff; padding:12px;
  border-radius:6px; border:1px solid #ccc;
}
#freeInput {
  width:100%; padding:10px; border-radius:6px;
  border:1px solid #aaa; font-size:15px;
}
#sendBtn, #summaryBtn {
  margin-top:10px; padding:10px 18px; color:white;
  border:none; border-radius:6px; cursor:pointer;
}
#sendBtn { background:#004080; }
#sendBtn:hover { background:#0050b3; }
#summaryBtn { background:#0066cc; margin-left:10px; }
#summaryBtn:hover { background:#0080ff; }

/* Sentiment */
#globalSentiment {
  position:absolute; top:12px; right:20px;
  font-size:14px; font-weight:bold; display:none;
}
.positive { color:green; }
.negative { color:red; }
.neutral { color:gray; }

/* Toggle switch */
.toggle-label {
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:bold;
  margin-bottom:10px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}
.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
.switch input:checked + .slider {
  background-color: #004080;
}
.switch input:checked + .slider:before {
  transform: translateX(22px);
}
.slider.round {
  border-radius: 34px;
}

/* R√©sum√© */
#summarySection {
  display:none;
  background:white;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  margin-top:20px;
  max-height:300px;
  overflow-y:auto;
}

#summaryText {
  white-space: normal;
  padding:10px;
  font-size:14px;
  line-height:1.45;
  color:#004080;
}

#loadingDots { font-weight:bold; font-size:18px; margin-top:8px; min-height:24px; }

</style>
</head>

<body>

<h2>Conversation avec l'Assistant Watson :</h2>

<label class="toggle-label">
  Analyse de sentiment
  <label class="switch">
    <input type="checkbox" id="sentimentToggle">
    <span class="slider round"></span>
  </label>
</label>

<div id="globalSentiment">Sentiment global : Attente de d√©but de la conversation üòê</div>

<div id="messageContainer"></div>

<h3>Suggestions de r√©ponses :</h3>
<div id="suggestionsList"><div>Aucune suggestion pour le moment...</div></div>

<div id="loadingDots"></div>

<div id="inputContainer">
<label for="freeInput"><strong>Saisir un message :</strong></label>
<input id="freeInput" type="text" placeholder="√âcrire le message ici‚Ä¶">
<button id="sendBtn">Envoyer</button>
<button id="summaryBtn">R√©sum√©</button>
</div>

<div id="summarySection">
  <h3>R√©sum√© de la conversation :</h3>
  <div id="summaryText"></div>
</div>

<script>
/* Markdown converter */
const mdConverter = new showdown.Converter({ tables: true, simplifiedAutoLink: true });

const messageContainer = document.getElementById("messageContainer");
const suggestionsList = document.getElementById("suggestionsList");
const freeInput = document.getElementById("freeInput");
const sendBtn = document.getElementById("sendBtn");
const summaryBtn = document.getElementById("summaryBtn");
const globalSentiment = document.getElementById("globalSentiment");
const sentimentToggle = document.getElementById("sentimentToggle");
const loadingDots = document.getElementById("loadingDots");
const summarySection = document.getElementById("summarySection");
const summaryText = document.getElementById("summaryText");

let clientId = localStorage.getItem("clientId");
if (!clientId) {
  clientId = "user-" + Date.now() + "-" + Math.floor(Math.random()*1000);
  localStorage.setItem("clientId", clientId);
}

let conversationSentiment = 0;
let userMessageCount = 0;
let sentimentEnabled = false;

/* Toggle sentiment */
sentimentToggle.addEventListener("change", () => {
  sentimentEnabled = sentimentToggle.checked;
  globalSentiment.style.display = sentimentEnabled ? "block" : "none";
});

/* Append message WITH MARKDOWN ‚Üí HTML */
function appendMessage(sender, message) {

  const html = mdConverter.makeHtml(message);

  const div = document.createElement("div");
  div.className = "chat-message";

  div.innerHTML = `
    <div class="sender">${sender} :</div>
    <div class="content">${html}</div>
    <hr>
  `;

  messageContainer.appendChild(div);
  messageContainer.scrollTop = messageContainer.scrollHeight;
}

/* Sentiment */
function updateGlobalSentiment(sentimentScore,isUserMessage){
  if(!sentimentEnabled) return;
  const weight = isUserMessage?2:1;
  conversationSentiment = ((conversationSentiment*userMessageCount)+(sentimentScore*weight))/(userMessageCount+weight);
  if(isUserMessage) userMessageCount++;

  let txt="Sentiment global : Neutre ", cls="neutral", emoji="üòê";

  if(conversationSentiment>0.5){ txt="Sentiment global : Positif "; cls="positive"; emoji="üòä";}
  else if(conversationSentiment<-0.5){ txt="Sentiment global : N√©gatif "; cls="negative"; emoji="üòû";}

  globalSentiment.textContent = `${txt}${emoji}`;
  globalSentiment.className = cls;
}

/* Loading animation */
function showLoadingAnimation(){
  let dots = 0;
  loadingDots.textContent = "";
  const interval = setInterval(()=>{ dots=(dots+1)%4; loadingDots.textContent=".".repeat(dots); }, 500);
  return interval;
}

/* Fetch Watson */
async function getWatsonResponse(message,senderType){
  const interval = showLoadingAnimation();
  try{
    const res = await fetch("https://watsson-agent.onrender.com/api/sendToOrchestrate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ message, clientId, sentimentEnabled })
    });
    if(!res.ok) throw new Error("Erreur API Orchestrate");
    const data = await res.json();

    clearInterval(interval); loadingDots.textContent="";

    updateGlobalSentiment(data.sentiment, senderType==="user");
    appendMessage("Assistant Watson", data.reply);

    /* Suggestions */
    suggestionsList.innerHTML="";
    let suggestions=[];
    if(Array.isArray(data.reply)) suggestions=data.reply;
    else suggestions=[data.reply];

    if(suggestions.length===0){
      suggestionsList.innerHTML="<div>Aucune suggestion disponible.</div>";
    } else {
      suggestions.forEach(r=>{
        const div=document.createElement("div");
        div.className="suggestion-item";
        div.innerHTML = mdConverter.makeHtml(r);
        div.addEventListener("click",async()=>{
          try{ await navigator.clipboard.writeText(r); alert("Texte copi√© !"); }
          catch(err){ console.error(err); }
        });
        suggestionsList.appendChild(div);
      });
    }

  }catch(err){
    clearInterval(interval); loadingDots.textContent="";
    appendMessage("Assistant Watson","Erreur lors de la r√©cup√©ration des suggestions.");
    suggestionsList.innerHTML="<div>Pas de suggestions disponibles.</div>";
  }
}

function sendMessageFromAgent(message){
  appendMessage("Agent",message);
  getWatsonResponse(message,"agent");
  freeInput.value="";
}

sendBtn.addEventListener("click", ()=>{
  const msg=freeInput.value.trim();
  if(msg) sendMessageFromAgent(msg);
});
freeInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    const msg=freeInput.value.trim();
    if(msg) sendMessageFromAgent(msg);
  }
});

/* R√©sum√© */
summaryBtn.addEventListener("click", async ()=>{
  const interval = showLoadingAnimation();
  try{
    const res = await fetch("https://watsson-agent.onrender.com/api/summarize", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ clientId })
    });
    clearInterval(interval); loadingDots.textContent="";
    if(!res.ok) throw new Error("Erreur API Summarizer");

    const data = await res.json();

    summaryText.innerHTML = mdConverter.makeHtml(data.summary);
    summarySection.style.display = summarySection.style.display==="none" ? "block" : "none";

  }catch(err){
    clearInterval(interval); loadingDots.textContent="";
    alert("Impossible de g√©n√©rer le r√©sum√© : " + err.message);
  }
});
</script>

</body>
</html>
