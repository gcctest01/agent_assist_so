<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistant Agent Assist - Watsonx Orchestrate</title>

<style>
body { font-family: Arial, sans-serif; margin: 12px; background: #f9f9f9; }

/* Titre principal */
h2 { 
    color:#004080; 
    font-size:26px; 
    margin-bottom:24px; 
}

h3,label strong { 
    color:#004080; 
    font-size:16px; 
}

/* Titres de sections */
.section-title {
    font-weight:bold;
    font-size:16px;
    color:#004080;
    margin:20px 0 6px 0;
    display:block;
}

/* ----------- Zone historique ----------- */
#messageContainer {
    background:#fff;
    border:1px solid #ccc;
    border-radius:6px;
    padding:12px;

    height:250px;
    max-height:250px;
    overflow-y:auto;

    margin-bottom:20px;
    white-space:pre-wrap;
    font-family:monospace;
}

/* ----------- Suggestions ----------- */
#suggestionsList { 
    border:1px solid #ccc; 
    border-radius:6px; 
    background:white; 
    max-height:200px; 
    overflow-y:auto; 
    padding:8px; 
    margin-bottom:10px; 
}
.suggestion-item { 
    padding:10px; 
    border-bottom:1px solid #eee; 
    cursor:pointer; 
    color:#004080; 
    white-space:pre-wrap; 
}
.suggestion-item:hover { background:#d0e1ff; }

/* ----------- Entr√©e utilisateur ----------- */
#inputContainer { 
    margin-top:20px; 
    background:#fff; 
    padding:12px; 
    border-radius:6px; 
    border:1px solid #ccc; 
}

#freeInput { 
    width:100%; 
    padding:10px; 
    border-radius:6px; 
    border:1px solid #aaa; 
    font-size:15px; 
}

/* ----------- Boutons ----------- */
#sendBtn, #generateSummaryBtn, #toggleSummaryBtn { 
    margin-top:10px; 
    padding:10px 18px; 
    color:white; 
    border:none; 
    border-radius:6px; 
    cursor:pointer;
    display:inline-block;
}

#sendBtn { background:#004080; }
#sendBtn:hover { background:#0050b3; }

#generateSummaryBtn { background:#00994d; margin-left:10px; }
#generateSummaryBtn:hover { background:#00b35c; }

#toggleSummaryBtn { background:#0066cc; margin-left:10px; }
#toggleSummaryBtn:hover { background:#0080ff; }

/* ----------- Sentiment global ----------- */
#globalSentiment { 
    position:absolute; 
    top:12px; 
    right:20px; 
    font-size:14px; 
    font-weight:bold; 
    display:none; 
}

.positive { color:green; }
.negative { color:red; }
.neutral { color:gray; }

/* ----------- Toggle switch ----------- */
.switch { 
    position:relative; 
    display:inline-block; 
    width:38px; 
    height:20px;
    margin-left:10px; 
    vertical-align:middle; 
}

.switch input { display:none; }

.slider { 
    position:absolute; 
    cursor:pointer; 
    top:0; left:0; right:0; bottom:0; 
    background-color:#ccc; 
    transition:0.4s; 
    border-radius:20px; 
}

.slider:before { 
    position:absolute; 
    content:""; 
    height:14px; 
    width:14px; 
    left:3px; 
    bottom:3px; 
    background:white; 
    transition:0.4s; 
    border-radius:50%; 
}

input:checked + .slider { background-color:#004080; }
input:checked + .slider:before { transform:translateX(18px); }

/* ----------- R√©sum√© ----------- */
#summarySection {
    display:none;
    background:#fff;
    padding:12px;
    border-radius:6px;
    border:1px solid #ccc;

    white-space:pre-wrap;
    font-family:monospace;

    max-height:300px;
    overflow-y:auto;

    margin-top:20px;
}

#loadingDots { 
    font-weight:bold; 
    font-size:18px; 
    margin-top:8px; 
    min-height:24px; 
}
</style>
</head>

<body>

<h2>Conversation avec l'Assistant Watson :</h2>

<label>
Analyse de sentiment
<div class="switch">
    <input type="checkbox" id="sentimentToggle">
    <span class="slider"></span>
</div>
</label>

<div id="globalSentiment">Sentiment global : Attente de d√©but de la conversation üòê</div>

<!-- TITRE HISTORIQUE -->
<span class="section-title">Transcript de la conversation :</span>
<div id="messageContainer"></div>

<!-- TITRE SUGGESTIONS -->
<span class="section-title">Suggestion de r√©ponse :</span>
<div id="suggestionsList"><div>Aucune suggestion pour le moment...</div></div>

<div id="loadingDots"></div>

<div id="inputContainer">
    <label for="freeInput" class="section-title">Saisir un message :</label>
    <input id="freeInput" type="text" placeholder="√âcrire le message ici‚Ä¶">

    <button id="sendBtn">Envoyer</button>
    <button id="generateSummaryBtn">G√©n√©rer un r√©sum√©</button>
    <button id="toggleSummaryBtn">Afficher le r√©sum√©</button>
</div>

<!-- TITRE R√âSUM√â -->
<span class="section-title" style="display:none;" id="summaryTitle">R√©sum√© de la conversation :</span>
<div id="summarySection">
    <div id="summaryText"></div>
</div>

<script>
/* DOM */
const messageContainer = document.getElementById("messageContainer");
const suggestionsList = document.getElementById("suggestionsList");
const freeInput = document.getElementById("freeInput");

const sendBtn = document.getElementById("sendBtn");
const generateSummaryBtn = document.getElementById("generateSummaryBtn");
const toggleSummaryBtn = document.getElementById("toggleSummaryBtn");

const summarySection = document.getElementById("summarySection");
const summaryTitle = document.getElementById("summaryTitle");
const summaryText = document.getElementById("summaryText");

const globalSentiment = document.getElementById("globalSentiment");
const sentimentToggle = document.getElementById("sentimentToggle");
const loadingDots = document.getElementById("loadingDots");

/* Gestion ID client */
let clientId = localStorage.getItem("clientId");
if (!clientId) {
  clientId = "user-" + Date.now() + "-" + Math.floor(Math.random()*1000);
  localStorage.setItem("clientId", clientId);
}

let conversationSentiment = 0;
let userMessageCount = 0;
let sentimentEnabled = false;

/* ----- Toggle sentiment ----- */
sentimentToggle.addEventListener("change", () => {
  sentimentEnabled = sentimentToggle.checked;
  globalSentiment.style.display = sentimentEnabled ? "block" : "none";
});

/* ----- Affichage messages ----- */
function appendMessage(sender,message){
  messageContainer.textContent += sender + " :\n-----------------\n" + message + "\n\n";
  messageContainer.scrollTop = messageContainer.scrollHeight;
}

function updateGlobalSentiment(sentimentScore,isUserMessage){
  if(!sentimentEnabled) return;
  const weight = isUserMessage?2:1;
  conversationSentiment = ((conversationSentiment*userMessageCount)+(sentimentScore*weight))/(userMessageCount+weight);
  if(isUserMessage) userMessageCount++;
  let sentimentText="Sentiment global : Neutre ", sentimentClass="neutral", emoji="üòê";
  if(conversationSentiment>0.5){ sentimentText="Sentiment global : Positif "; sentimentClass="positive"; emoji="üòä"; }
  else if(conversationSentiment<-0.5){ sentimentText="Sentiment global : N√©gatif "; sentimentClass="negative"; emoji="üòû"; }
  globalSentiment.textContent = `${sentimentText}${emoji}`;
  globalSentiment.className = sentimentClass;
}

function showLoadingAnimation(){
  let dots = 0;
  loadingDots.textContent = "";
  const interval = setInterval(()=>{ dots=(dots+1)%4; loadingDots.textContent=".".repeat(dots); }, 500);
  return interval;
}

/* ----- Appel Watson ----- */
async function getWatsonResponse(message,senderType){
  const interval = showLoadingAnimation();
  try{
    const res = await fetch("https://watsson-agent.onrender.com/api/sendToOrchestrate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ message, clientId, sentimentEnabled })
    });

    if(!res.ok) throw new Error("Erreur API");

    const data = await res.json();
    clearInterval(interval); loadingDots.textContent="";
    updateGlobalSentiment(data.sentiment, senderType==="user");
    appendMessage("Assistant Watson", data.reply);

    suggestionsList.innerHTML="";
    let suggestions=[];
    if(Array.isArray(data.reply)) suggestions=data.reply;
    else if(typeof data.reply==="string" && data.reply.trim()) suggestions=[data.reply];

    if(suggestions.length===0){
        suggestionsList.innerHTML="<div>Aucune suggestion disponible.</div>";
    } else {
        suggestions.forEach(r=>{
            const div=document.createElement("div");
            div.className="suggestion-item"; 
            div.innerText = r;
            div.addEventListener("click",async()=>{
              try{ await navigator.clipboard.writeText(r); alert("Texte copi√© !"); }
              catch(err){ console.error(err); }
            });
            suggestionsList.appendChild(div);
        });
    }

  }catch(error){
    clearInterval(interval); loadingDots.textContent="";
    appendMessage("Assistant Watson","Erreur lors de la r√©cup√©ration des suggestions.");
  }
}

function sendMessageFromAgent(message){
  appendMessage("Agent",message);
  getWatsonResponse(message,"agent");
  freeInput.value="";
}

/* ----- Bouton envoyer ----- */
sendBtn.addEventListener("click",()=>{ 
  const message=freeInput.value.trim();
  if(message) sendMessageFromAgent(message);
});
freeInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    const message=freeInput.value.trim();
    if(message) sendMessageFromAgent(message);
  }
});

/* ----- G√©n√©rer un r√©sum√© ----- */
generateSummaryBtn.addEventListener("click", async ()=>{
    const interval = showLoadingAnimation();

    try{
        const res = await fetch("https://watsson-agent.onrender.com/api/summarize", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ clientId })
        });

        clearInterval(interval);
        loadingDots.textContent="";

        const data = await res.json();

        summaryText.innerHTML = data.summary;
        summarySection.style.display = "block";
        summaryTitle.style.display = "block";

        toggleSummaryBtn.textContent = "Masquer le r√©sum√©";

    }catch(err){
        clearInterval(interval);
        loadingDots.textContent="";
        alert("Erreur lors du r√©sum√© : " + err.message);
    }
});

/* ----- Toggle Afficher / Masquer r√©sum√© ----- */
toggleSummaryBtn.addEventListener("click", ()=>{

    const isVisible = summarySection.style.display === "block";

    if (isVisible) {
        summarySection.style.display = "none";
        summaryTitle.style.display = "none";
        toggleSummaryBtn.textContent = "Afficher le r√©sum√©";
    } else {
        summarySection.style.display = "block";
        summaryTitle.style.display = "block";
        toggleSummaryBtn.textContent = "Masquer le r√©sum√©";
    }

});
</script>

</body>
</html>
