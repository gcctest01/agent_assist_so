<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant Agent Assist - Watsonx Orchestrate</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; background: #f9f9f9; }
    h2,h3 { color:#004080; }
    #messageContainer { background:#fff; border:1px solid #ccc; border-radius:6px; padding:12px; max-height:500px; overflow-y:auto; margin-bottom:20px; white-space:pre-wrap; font-family:monospace; }
    #suggestionsList { border:1px solid #ccc; border-radius:6px; background:white; max-height:200px; overflow-y:auto; padding:8px; margin-bottom:10px; }
    .suggestion-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer; color:#004080; white-space:pre-wrap; }
    .suggestion-item:hover { background:#d0e1ff; }
    #inputContainer { margin-top:20px; background:#fff; padding:12px; border-radius:6px; border:1px solid #ccc; }
    #freeInput { width:100%; padding:10px; border-radius:6px; border:1px solid #aaa; font-size:15px; }
    #sendBtn { margin-top:10px; padding:10px 18px; background:#004080; color:white; border:none; border-radius:6px; cursor:pointer; }
    #sendBtn:hover { background:#0050b3; }
    #globalSentiment { position:absolute; top:12px; right:20px; font-size:14px; font-weight:bold; display:none; }
    .positive { color:green; }
    .negative { color:red; }
    .neutral { color:gray; }

    /* Toggle switch */
    .switch { position:relative; display:inline-block; width:50px; height:28px; margin-left:10px; vertical-align:middle; }
    .switch input { display:none; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:0.4s; border-radius:34px; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:4px; bottom:4px; background:white; transition:0.4s; border-radius:50%; }
    input:checked + .slider { background-color:#004080; }
    input:checked + .slider:before { transform:translateX(22px); }

    /* Tool buttons */
    #inputTools button, #inputTools label {
      cursor:pointer;
      border-radius:6px;
      border:1px solid #ccc;
      background:#eee;
      padding:6px 10px;
      font-size:18px;
    }

    #loadingDots { font-weight:bold; font-size:18px; margin-top:8px; min-height:24px; }
  </style>
</head>
<body>

<h2>Conversation avec l'Assistant Watson :</h2>

<label>
  Analyse de sentiment
  <div class="switch">
    <input type="checkbox" id="sentimentToggle">
    <span class="slider"></span>
  </div>
</label>

<div id="globalSentiment">Sentiment global : Attente de d√©but de la conversation üòê</div>

<div id="messageContainer"></div>

<h3>Suggestions de r√©ponses :</h3>
<div id="suggestionsList"><div>Aucune suggestion pour le moment...</div></div>
<div id="loadingDots"></div>

<div id="inputContainer">
  <label for="freeInput"><strong>Saisir un message :</strong></label>
  <input id="freeInput" type="text" placeholder="√âcrire le message ici‚Ä¶">

  <!-- üîß Nouveaux outils -->
  <div id="inputTools" style="margin-top:10px; display:flex; gap:10px; align-items:center;">
    <button id="emojiBtn" title="Ajouter un emoji">üòä</button>

    <label for="fileInput">üìé Joindre</label>
    <input type="file" id="fileInput" style="display:none;">
    <span id="fileName" style="font-size:14px; color:#555;"></span>
  </div>

  <button id="sendBtn">Envoyer</button>
</div>

<script>
const messageContainer = document.getElementById("messageContainer");
const suggestionsList = document.getElementById("suggestionsList");
const freeInput = document.getElementById("freeInput");
const sendBtn = document.getElementById("sendBtn");
const globalSentiment = document.getElementById("globalSentiment");
const sentimentToggle = document.getElementById("sentimentToggle");
const loadingDots = document.getElementById("loadingDots");

let clientId = localStorage.getItem("clientId");
if (!clientId) {
  clientId = "user-" + Date.now() + "-" + Math.floor(Math.random()*1000);
  localStorage.setItem("clientId", clientId);
}

let conversationSentiment = 0;
let userMessageCount = 0;
let sentimentEnabled = false;

sentimentToggle.addEventListener("change", () => {
  sentimentEnabled = sentimentToggle.checked;
  globalSentiment.style.display = sentimentEnabled ? "block" : "none";
});

function appendMessage(sender,message){
  messageContainer.textContent += sender + " :\n-----------------\n" + message + "\n\n";
  messageContainer.scrollTop = messageContainer.scrollHeight;
}

function updateGlobalSentiment(sentimentScore,isUserMessage){
  if(!sentimentEnabled) return;
  const weight = isUserMessage?2:1;
  conversationSentiment = ((conversationSentiment*userMessageCount)+(sentimentScore*weight))/(userMessageCount+weight);
  if(isUserMessage) userMessageCount++;
  let sentimentText="Sentiment global : Neutre ", sentimentClass="neutral", emoji="üòê";
  if(conversationSentiment>0.5){ sentimentText="Sentiment global : Positif "; sentimentClass="positive"; emoji="üòä"; }
  else if(conversationSentiment<-0.5){ sentimentText="Sentiment global : N√©gatif "; sentimentClass="negative"; emoji="üòû"; }
  globalSentiment.textContent = `${sentimentText}${emoji}`;
  globalSentiment.className = sentimentClass;
}

function showLoadingAnimation(){
  let dots = 0;
  loadingDots.textContent = "";
  const interval = setInterval(()=>{ dots=(dots+1)%4; loadingDots.textContent=".".repeat(dots); }, 500);
  return interval;
}

async function getWatsonResponse(message,senderType){
  const interval = showLoadingAnimation();
  try{
    const res = await fetch("https://watsson-agent.onrender.com/api/sendToOrchestrate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ message, clientId, sentimentEnabled })
    });
    if(!res.ok) throw new Error("Erreur API Orchestrate");

    const data = await res.json();
    clearInterval(interval);
    loadingDots.textContent="";

    updateGlobalSentiment(data.sentiment, senderType==="user");
    appendMessage("Assistant Watson", data.reply);

    // üîß Correction suggestions multi-lignes
    suggestionsList.innerHTML="";
    let suggestions=[];
    if(Array.isArray(data.reply)) suggestions=data.reply;
    else if(typeof data.reply==="string" && data.reply.trim()) suggestions=[data.reply];

    if(suggestions.length===0) suggestionsList.innerHTML="<div>Aucune suggestion disponible.</div>";
    else{
      suggestions.forEach(r=>{
        const div=document.createElement("div");
        div.className="suggestion-item";
        div.innerText = r;  // <-- Garde les retours √† la ligne üî•
        div.addEventListener("click",async()=>{
          try{ await navigator.clipboard.writeText(r); alert("Texte copi√© dans le presse-papier !"); }
          catch(err){ console.error("Impossible de copier le texte :",err); }
        });
        suggestionsList.appendChild(div);
      });
    }
  }catch(error){
    clearInterval(interval);
    loadingDots.textContent="";
    appendMessage("Assistant Watson","Erreur lors de la r√©cup√©ration des suggestions.");
    suggestionsList.innerHTML="<div>Pas de suggestions disponibles.</div>";
  }
}

function sendMessageFromAgent(message){
  appendMessage("Agent",message);
  getWatsonResponse(message,"agent");
  freeInput.value="";
}

sendBtn.addEventListener("click",()=>{
  const message=freeInput.value.trim();
  if(message) sendMessageFromAgent(message);
});

freeInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    const message=freeInput.value.trim();
    if(message) sendMessageFromAgent(message);
  }
});

/* --- Emoji Picker --- */
const emojiBtn = document.getElementById("emojiBtn");
emojiBtn.addEventListener("click", () => {
  const emojis = ["üòÄ","üòÅ","üòÇ","üòç","üòé","ü§î","üëç","üôè","üî•","üéâ","üöÄ","‚ù§Ô∏è"];
  const emoji = prompt("Choisissez un emoji :\n" + emojis.join(" "));
  if (emoji) {
    freeInput.value += emoji;
    freeInput.focus();
  }
});

/* --- Pi√®ce jointe --- */
const fileInput = document.getElementById("fileInput");
const fileName = document.getElementById("fileName");

fileInput.addEventListener("change", () => {
  if (fileInput.files.length > 0) {
    fileName.textContent = "Fichier s√©lectionn√© : " + fileInput.files[0].name;
  } else {
    fileName.textContent = "";
  }
});
</script>

</body>
</html>
