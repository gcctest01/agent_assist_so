<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant Agent Assist - Watsonx Orchestrate</title>
  <style>
    /* Styles pour l'interface utilisateur */
    body {
      font-family: Arial, sans-serif;
      margin: 12px;
      background: #f9f9f9;
    }
    h2, h3 { color: #004080; }

    #messageContainer {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 20px;
      white-space: pre-wrap;
      font-family: monospace;
    }

    #suggestionsList {
      border: 1px solid #ccc;
      border-radius: 6px;
      background: white;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      margin-bottom: 20px;
    }

    .suggestion-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      color: #004080;
    }
    .suggestion-item:hover { background: #d0e1ff; }

    #inputContainer {
      margin-top: 20px;
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #freeInput {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #aaa;
      font-size: 15px;
    }
    #sendBtn {
      margin-top: 10px;
      padding: 10px 18px;
      background: #004080;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #sendBtn:hover { background: #0050b3; }

    /* Styles pour l'indicateur de sentiment global */
    .sentiment-state {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: 30px;
      background-color: #f1f1f1;
    }

    .sentiment-state span {
      margin-left: 10px;
    }

    .emoji {
      font-size: 25px;
    }

    /* Couleurs de l'√©tat de sentiment */
    .sentiment-neutral {
      color: black;
    }

    .sentiment-positive {
      color: green;
    }

    .sentiment-negative {
      color: red;
    }
  </style>
</head>
<body>

<h2>Conversation avec l'Assistant Watson :</h2>

<!-- Etat global du sentiment -->
<div id="sentimentState" class="sentiment-state sentiment-neutral">
  <span class="emoji" id="sentimentEmoji">üòê</span>
  <span id="sentimentText">Sentiment de la conversation : Attente de d√©but de la conversation</span>
</div>

<div id="messageContainer">
  <!-- Historique complet des messages -->
</div>

<h3>Suggestions de r√©ponses :</h3>
<div id="suggestionsList">
  <div>Aucune suggestion pour le moment...</div>
</div>

<div id="inputContainer">
  <label for="freeInput"><strong>Saisir un message :</strong></label>
  <input id="freeInput" type="text" placeholder="√âcrire le message ici‚Ä¶">
  <button id="sendBtn">Envoyer</button>
</div>

<script src="https://sfrrec00-sfrvalid.sfrtestglobalcc.com/OneAgentWeb/js/agentsdk/oneagentSDK.js"></script>
<script>
// S√©lection des √©l√©ments DOM
const messageContainer = document.getElementById("messageContainer");
const suggestionsList = document.getElementById("suggestionsList");
const freeInput = document.getElementById("freeInput");
const sendBtn = document.getElementById("sendBtn");

// G√©n√©ration d'un ID client unique
let clientId = localStorage.getItem("clientId");
if (!clientId) {
  clientId = "user-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
  localStorage.setItem("clientId", clientId);
}

// Variables pour g√©rer l'√©tat de sentiment global
let sentimentScore = 0;  // Score global de sentiment initial (neutre)
let messages = [];  // Historique des messages √©chang√©s

// Fonction pour afficher un message dans la conversation
function appendMessage(sender, message) {
  messageContainer.textContent += sender + " :\n-----------------\n" + message + "\n\n";
  messageContainer.scrollTop = messageContainer.scrollHeight;
}

// Fonction pour mettre √† jour l'√©tat global du sentiment
function updateSentimentState() {
  let sentimentText = "Attente de d√©but de la conversation";
  let emoji = "üòê";
  let sentimentClass = "sentiment-neutral";

  if (sentimentScore > 0.5) {
    sentimentText = "Sentiment de la conversation : Positif";
    emoji = "üòä";
    sentimentClass = "sentiment-positive";
  } else if (sentimentScore < -0.5) {
    sentimentText = "Sentiment de la conversation : N√©gatif";
    emoji = "‚òπÔ∏è";
    sentimentClass = "sentiment-negative";
  }

  document.getElementById('sentimentState').className = `sentiment-state ${sentimentClass}`;
  document.getElementById('sentimentText').textContent = sentimentText;
  document.getElementById('sentimentEmoji').textContent = emoji;
}

// Fonction pour calculer le sentiment global de la conversation
async function analyzeSentimentOfConversation() {
  // Ici, vous pouvez int√©grer une analyse de sentiment plus avanc√©e
  // Pour l'instant, nous calculons le sentiment moyen de tous les messages

  const totalSentiment = messages.reduce((acc, msg) => acc + (msg.sentiment || 0), 0);
  sentimentScore = totalSentiment / messages.length;

  updateSentimentState();  // Mettre √† jour l'affichage de l'√©tat global de sentiment
}

// Fonction pour r√©cup√©rer la r√©ponse de Watson et afficher le sentiment
async function getWatsonResponse(message, senderType) {
  try {
    const res = await fetch("https://watsson-agent.onrender.com/api/sendToOrchestrate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: message, clientId })
    });

    if (!res.ok) throw new Error("Erreur API Orchestrate");

    const data = await res.json();
    const replies = Array.isArray(data.reply) ? data.reply : [data.reply];
    const sentimentScore = data.sentiment || 0;  // Obtenez le score de sentiment du message

    // Ajouter le message et son sentiment √† l'historique
    messages.push({ role: senderType, content: message, sentiment: sentimentScore });

    // Afficher chaque r√©ponse de Watson
    replies.forEach(r => appendMessage("Assistant Watson", r));

    // Mettre √† jour l'√©tat global du sentiment
    await analyzeSentimentOfConversation();

    // Mettre les suggestions dans la liste cliquable
    suggestionsList.innerHTML = "";
    replies.forEach(r => {
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.textContent = r;
      div.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(r);
          alert("Texte copi√© dans le presse-papier !");
        } catch (err) {
          console.error("Impossible de copier le texte :", err);
        }
      });
      suggestionsList.appendChild(div);
    });

  } catch (error) {
    console.error("Erreur r√©cup√©ration Watsonx:", error);
    appendMessage("Assistant Watson", "Erreur lors de la r√©cup√©ration des suggestions.");
    suggestionsList.innerHTML = "<div>Erreur lors de la r√©cup√©ration des suggestions.</div>";
  }
}

// Envoi message Agent
function sendMessageFromAgent(message) {
  appendMessage("Agent", message);
  getWatsonResponse(message, "agent");
  freeInput.value = "";
}

// √âv√©nement clic sur Envoyer
sendBtn.addEventListener("click", () => {
  const message = freeInput.value.trim();
  if (message) sendMessageFromAgent(message);
});

// √âv√©nement Enter
freeInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    const message = freeInput.value.trim();
    if (message) sendMessageFromAgent(message);
  }
});

// Recevoir message Client via OneAgent
let api;
if (typeof getAgentAPI === "function") api = getAgentAPI();
else if (typeof oneAgentSDK === "function") api = new oneAgentSDK();

if (api) {
  api.onCallMessageReceived = async function(event) {
    const call = event.Call || {};
    const msg = call.IMMessage || "Message inconnu";
    appendMessage("Client", msg);
    await getWatsonResponse(msg, "client");
  };
}
</script>

</body>
</html>
